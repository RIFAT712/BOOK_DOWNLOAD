<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlipHTML5 Downloader</title>
<style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#f4f7f6; color:#333; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
    .container { background:#fff; padding:2rem 3rem; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.1); width:90%; max-width:500px; text-align:center; }
    h1 { color:#1a252f; margin-bottom:1.5rem; }
    .form-group { margin-bottom:1.5rem; }
    input[type="text"] { width:100%; padding:12px; border:1px solid #ccc; border-radius:6px; font-size:1rem; box-sizing:border-box; }
    .btn { padding:12px 24px; border:none; border-radius:6px; font-size:1rem; cursor:pointer; transition:0.3s; margin:5px; }
    .btn-primary { background:#007bff; color:#fff; width:100%; }
    .btn-primary:hover { background:#0056b3; }
    .btn-secondary { background:#6c757d; color:#fff; }
    .btn-danger { background:#dc3545; color:#fff; }
    #progress-area, #compression-progress-area { display:none; margin-top:1.5rem; }
    .progress-bar { width:100%; background:#e9ecef; border-radius:6px; overflow:hidden; margin-bottom:1rem; }
    .progress-bar-inner { height:20px; width:0%; background:#28a745; text-align:center; color:white; line-height:20px; font-size:0.8rem; transition:width 0.4s ease; }
    #compression-progress-bar-inner { background:#17a2b8; }
    .status-text { font-weight:bold; margin-bottom:1rem; }
    #download-link a { display:inline-block; margin-top:1rem; font-size:1.2rem; text-decoration:none; }
</style>
</head>
<body>
<div class="container">
    <h1>Book Downloader</h1>
    <div id="start-form">
        <div class="form-group">
            <input type="text" id="book-name" placeholder="Enter Book ID (e.g., lzrut/orxa)" required>
        </div>
        <button class="btn btn-primary" onclick="startDownload()">Start Download</button>
    </div>

    <div id="progress-area">
        <p id="status-text" class="status-text">Starting...</p>
        <div class="progress-bar"><div id="progress-bar-inner" class="progress-bar-inner">0%</div></div>
    </div>

    <div id="compression-progress-area">
        <p id="compression-status-text" class="status-text">Compressing...</p>
        <div class="progress-bar"><div id="compression-progress-bar-inner" class="progress-bar-inner">0%</div></div>
    </div>

    <div id="controls" style="display:none;">
        <button class="btn btn-secondary" id="pause-resume-btn" onclick="togglePause()">Pause</button>
        <button class="btn btn-danger" onclick="cancelJob()">Cancel</button>
    </div>
    <div id="download-link"></div>
</div>

<script>
let jobId=null, progressInterval=null, isPaused=false;
const startForm=document.getElementById('start-form');
const progressArea=document.getElementById('progress-area');
const statusText=document.getElementById('status-text');
const progressBarInner=document.getElementById('progress-bar-inner');
const downloadLinkDiv=document.getElementById('download-link');
const controlsDiv=document.getElementById('controls');
const pauseResumeBtn=document.getElementById('pause-resume-btn');
const compressionProgressArea=document.getElementById('compression-progress-area');
const compressionStatusText=document.getElementById('compression-status-text');
const compressionProgressBarInner=document.getElementById('compression-progress-bar-inner');

function resetUI(){
    startForm.style.display='block';
    progressArea.style.display='none';
    compressionProgressArea.style.display='none';
    controlsDiv.style.display='none';
    downloadLinkDiv.innerHTML='';
    statusText.textContent='Starting job...';
    progressBarInner.style.width='0%'; progressBarInner.textContent='0%';
    compressionProgressBarInner.style.width='0%'; compressionProgressBarInner.textContent='0%';
    pauseResumeBtn.textContent='Pause'; isPaused=false;
    if(progressInterval){ clearInterval(progressInterval); progressInterval=null; }
    jobId=null;
}

async function startDownload(){
    const bookName=document.getElementById('book-name').value;
    if(!bookName){ alert('Please enter a Book ID.'); return; }
    resetUI(); startForm.style.display='none'; progressArea.style.display='block'; controlsDiv.style.display='block';
    const formData=new FormData(); formData.append('book_name',bookName);
    try{
        const response=await fetch('/start',{method:'POST',body:formData});
        const data=await response.json();
        if(response.ok && data.status==='started'){
            jobId=data.job_id;
            progressInterval=setInterval(pollProgress,1500);
        }else{
            statusText.textContent=`Error: ${data.message}`;
            startForm.style.display='block'; progressArea.style.display='none';
        }
    }catch(error){
        statusText.textContent='Error: Could not connect to server.'; resetUI();
    }
}

async function pollProgress(){
    if(!jobId) return;
    try{
        const response=await fetch(`/progress?job_id=${jobId}`);
        if(response.status===404){ statusText.textContent='Job not found.'; clearInterval(progressInterval); resetUI(); return; }
        const data=await response.json();
        const {status,done,total,compression_done,compression_total}=data;
        let downloadPercentage=total>0?Math.round((done/total)*100):0;
        progressBarInner.style.width=`${downloadPercentage}%`;
        progressBarInner.textContent=`${downloadPercentage}%`;
        let compressionPercentage=compression_total>0?Math.round((compression_done/compression_total)*100):0;
        compressionProgressBarInner.style.width=`${compressionPercentage}%`;
        compressionProgressBarInner.textContent=`${compressionPercentage}%`;
        switch(status){
            case 'downloading': statusText.textContent=`Downloading... (${done} / ${total})`; break;
            case 'paused': statusText.textContent=`Paused (${done} / ${total})`; break;
            case 'compressing': statusText.textContent='✅ Download complete!'; compressionProgressArea.style.display='block'; compressionStatusText.textContent=`Compressing images... (${compression_done} / ${compression_total})`; break;
            case 'creating_pdf': compressionStatusText.textContent=`Creating PDF...`; break;
            case 'done': statusText.textContent='✅ PDF Ready!'; compressionProgressArea.style.display='none'; clearInterval(progressInterval);
                const downloadUrl=`/download?job_id=${jobId}`;
                downloadLinkDiv.innerHTML=`<a href="${downloadUrl}" class="btn btn-primary">Download PDF</a>`;
                controlsDiv.style.display='none'; break;
            case 'failed': statusText.textContent='❌ Job failed.'; clearInterval(progressInterval); controlsDiv.style.display='none';
                downloadLinkDiv.innerHTML=`<button class="btn btn-secondary" onclick="resetUI()">Try Again</button>`; break;
        }
    }catch(error){ statusText.textContent='Connection lost. Retrying...'; console.error(error); }
}

async function togglePause(){
    if(!jobId) return;
    const action=isPaused?'resume':'pause';
    const formData=new FormData(); formData.append('job_id',jobId); formData.append('action',action);
    await fetch('/pause',{method:'POST',body:formData});
    isPaused=!isPaused; pauseResumeBtn.textContent=isPaused?'Resume':'Pause';
}

async function cancelJob(){
    if(!jobId) return;
    clearInterval(progressInterval);
    const formData=new FormData(); formData.append('job_id',jobId);
    await fetch('/cancel',{method:'POST',body:formData});
    resetUI(); document.getElementById('book-name').value='';
}
</script>
</body>
</html>
